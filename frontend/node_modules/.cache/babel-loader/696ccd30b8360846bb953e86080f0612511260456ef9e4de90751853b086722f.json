{"ast":null,"code":"import { proxy, snapshot } from 'valtio/vanilla';\nimport { subscribeKey as subKey } from 'valtio/vanilla/utils';\nimport { AccountController } from './AccountController.js';\nimport { ChainController } from './ChainController.js';\nimport { ConnectorController } from './ConnectorController.js';\nimport { ModalController } from './ModalController.js';\nimport { OptionsController } from './OptionsController.js';\n// -- State --------------------------------------------- //\nconst state = proxy({\n  view: 'Connect',\n  history: ['Connect'],\n  transactionStack: []\n});\n// -- Controller ---------------------------------------- //\nexport const RouterController = {\n  state,\n  subscribeKey(key, callback) {\n    return subKey(state, key, callback);\n  },\n  pushTransactionStack(action) {\n    state.transactionStack.push(action);\n  },\n  popTransactionStack(cancel) {\n    const action = state.transactionStack.pop();\n    if (!action) {\n      return;\n    }\n    if (cancel) {\n      // When the transaction is cancelled, we go back to the previous view\n      this.goBack();\n      action?.onCancel?.();\n    } else {\n      // When the transaction is successful, we do conditional navigation depending on the action properties\n      if (action.goBack) {\n        this.goBack();\n      } else if (action.replace) {\n        /*\n         *  If the history like [\"ConnectingSiwe\", \"ApproveTransaction\"], this means SIWE popup is opened after page rendered (not after user interaction)\n         *  we need to conditionally call replace.\n         *  There is a chance that there is only these two views in the history; when user approved, the modal should closed and history should be empty (both connectingsiwe and approveTX should be removed)\n         *  If there is another views before the ConnectingSiwe (if the CS is not the first view), we should back to the first view before CS.\n         */\n        const history = state.history;\n        const connectingSiweIndex = history.indexOf('ConnectingSiwe');\n        if (connectingSiweIndex > 0) {\n          // There are views before ConnectingSiwe\n          this.goBackToIndex(connectingSiweIndex - 1);\n        } else {\n          // ConnectingSiwe is the first view\n          ModalController.close();\n          state.history = [];\n        }\n      } else if (action.view) {\n        this.reset(action.view);\n      }\n      action?.onSuccess?.();\n    }\n  },\n  push(view, data) {\n    if (view !== state.view) {\n      state.view = view;\n      state.history.push(view);\n      state.data = data;\n    }\n  },\n  reset(view, data) {\n    state.view = view;\n    state.history = [view];\n    state.data = data;\n  },\n  replace(view, data) {\n    const lastView = state.history.at(-1);\n    const isSameView = lastView === view;\n    if (!isSameView) {\n      state.view = view;\n      state.history[state.history.length - 1] = view;\n      state.data = data;\n    }\n  },\n  goBack() {\n    const shouldReload = !ChainController.state.activeCaipAddress && this.state.view === 'ConnectingFarcaster';\n    if (state.history.length > 1 && !state.history.includes('UnsupportedChain')) {\n      state.history.pop();\n      const [last] = state.history.slice(-1);\n      if (last) {\n        state.view = last;\n      }\n    } else {\n      ModalController.close();\n    }\n    if (state.data?.wallet) {\n      state.data.wallet = undefined;\n    }\n    // Reloading the iframe contentwindow and doing the view animation in the modal causes a small freeze in the transition. Doing these separately fixes that.\n    setTimeout(() => {\n      if (shouldReload) {\n        AccountController.setFarcasterUrl(undefined, ChainController.state.activeChain);\n        const authConnector = ConnectorController.getAuthConnector();\n        authConnector?.provider?.reload();\n        const optionsState = snapshot(OptionsController.state);\n        authConnector?.provider?.syncDappData?.({\n          metadata: optionsState.metadata,\n          sdkVersion: optionsState.sdkVersion,\n          projectId: optionsState.projectId,\n          sdkType: optionsState.sdkType\n        });\n      }\n    }, 100);\n  },\n  goBackToIndex(historyIndex) {\n    if (state.history.length > 1) {\n      state.history = state.history.slice(0, historyIndex + 1);\n      const [last] = state.history.slice(-1);\n      if (last) {\n        state.view = last;\n      }\n    }\n  }\n};","map":{"version":3,"names":["proxy","snapshot","subscribeKey","subKey","AccountController","ChainController","ConnectorController","ModalController","OptionsController","state","view","history","transactionStack","RouterController","key","callback","pushTransactionStack","action","push","popTransactionStack","cancel","pop","goBack","onCancel","replace","connectingSiweIndex","indexOf","goBackToIndex","close","reset","onSuccess","data","lastView","at","isSameView","length","shouldReload","activeCaipAddress","includes","last","slice","wallet","undefined","setTimeout","setFarcasterUrl","activeChain","authConnector","getAuthConnector","provider","reload","optionsState","syncDappData","metadata","sdkVersion","projectId","sdkType","historyIndex"],"sources":["../../../../src/controllers/RouterController.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}