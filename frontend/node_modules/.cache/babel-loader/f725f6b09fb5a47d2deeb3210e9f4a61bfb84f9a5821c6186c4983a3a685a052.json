{"ast":null,"code":"import { Connection } from \"./core/connection.js\";\nimport { DEFAULT_POPUP_HEIGHT_PX, DEFAULT_POPUP_WIDTH_PX } from \"./core/constants.js\";\nimport { PopupEvent } from \"./core/types.js\";\nimport { openPopup, validateOrigin } from \"./core/utils.js\";\nexport class ConnectionManager {\n  constructor(platform) {\n    this.platform = platform;\n    this.connection = null;\n    this.popupWindow = null;\n    this.handleMessage = e => {\n      var _a, _b;\n      if (!validateOrigin(e.origin)) {\n        return;\n      }\n      const validatedOrigin = e.origin;\n      if (!this.popupWindow) {\n        return;\n      }\n      if (e.data.event === PopupEvent.HANDSHAKE && !this.connection) {\n        if (!this.verifyAndResetNonce((_a = e.data.payload) === null || _a === void 0 ? void 0 : _a.nonce)) {\n          return;\n        }\n        this.popupWindow.postMessage({\n          event: PopupEvent.HANDSHAKE_ACK,\n          payload: {\n            platform: this.platform\n          }\n        }, validatedOrigin);\n        this.connection = new Connection(validatedOrigin, this.popupWindow);\n        (_b = this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(this, this.connection);\n      }\n      if (!this.connection) {\n        return;\n      }\n      this.connection.runHandlersForEvent(e.data.event, e.data.payload);\n      if (e.data.event === PopupEvent.POPUP_CLOSED && this.connection) {\n        this.resetConnection();\n        this.popupWindow = null;\n      }\n    };\n  }\n  initialize() {\n    window.addEventListener('message', this.handleMessage);\n    return this;\n  }\n  tearDown() {\n    window.removeEventListener('message', this.handleMessage);\n    this.resetConnection();\n    return this;\n  }\n  async open({\n    url,\n    widthPx = DEFAULT_POPUP_WIDTH_PX,\n    heightPx = DEFAULT_POPUP_HEIGHT_PX,\n    nonce\n  }) {\n    var _a;\n    if ((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.closed) {\n      this.resetConnectionAndPopupWindow();\n    }\n    if (this.popupWindow) {\n      return;\n    }\n    this.initialize();\n    if (nonce) {\n      this.nonce = nonce;\n    }\n    const left = window.screenX + (window.innerWidth - widthPx) / 2;\n    const top = window.screenY + (window.innerHeight - heightPx) / 2;\n    this.popupWindow = openPopup({\n      height: heightPx,\n      left,\n      top,\n      url: typeof url === 'string' ? url : undefined,\n      width: widthPx\n    });\n    if (url instanceof Promise) {\n      this.setUrl(await url);\n    }\n  }\n  close() {\n    if (!this.popupWindow) {\n      return;\n    }\n    this.popupWindow.close();\n    this.resetConnectionAndPopupWindow();\n  }\n  onConnectionUpdated(callback) {\n    this.connectionUpdatedCallback = callback;\n    return this;\n  }\n  getConnection() {\n    return this.connection;\n  }\n  setUrl(url) {\n    if (!this.popupWindow) {\n      return;\n    }\n    this.popupWindow.location = url;\n  }\n  resetConnectionAndPopupWindow() {\n    this.resetConnection();\n    this.popupWindow = null;\n  }\n  resetConnection() {\n    var _a, _b;\n    (_a = this.connection) === null || _a === void 0 ? void 0 : _a.resetHandlers();\n    this.connection = null;\n    (_b = this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(this, this.connection);\n  }\n  verifyAndResetNonce(uncheckedNonce) {\n    if (!this.nonce) {\n      return true;\n    }\n    const result = uncheckedNonce === this.nonce;\n    if (result) {\n      this.nonce = undefined;\n    }\n    return result;\n  }\n}","map":{"version":3,"names":["Connection","DEFAULT_POPUP_HEIGHT_PX","DEFAULT_POPUP_WIDTH_PX","PopupEvent","openPopup","validateOrigin","ConnectionManager","constructor","platform","connection","popupWindow","handleMessage","e","origin","validatedOrigin","data","event","HANDSHAKE","verifyAndResetNonce","_a","payload","nonce","postMessage","HANDSHAKE_ACK","_b","connectionUpdatedCallback","call","runHandlersForEvent","POPUP_CLOSED","resetConnection","initialize","window","addEventListener","tearDown","removeEventListener","open","url","widthPx","heightPx","closed","resetConnectionAndPopupWindow","left","screenX","innerWidth","top","screenY","innerHeight","height","undefined","width","Promise","setUrl","close","onConnectionUpdated","callback","getConnection","location","resetHandlers","uncheckedNonce","result"],"sources":["../../src/connection-manager.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}