{"ast":null,"code":"import { proxy, ref } from 'valtio/vanilla';\nimport { subscribeKey as subKey } from 'valtio/vanilla/utils';\nimport '@reown/appkit-common';\nimport { CoreHelperUtil } from '../utils/CoreHelperUtil.js';\nimport { SIWXUtil } from '../utils/SIWXUtil.js';\nimport { StorageUtil } from '../utils/StorageUtil.js';\nimport { ChainController } from './ChainController.js';\nimport { ConnectorController } from './ConnectorController.js';\nimport { EventsController } from './EventsController.js';\nimport { ModalController } from './ModalController.js';\nimport { RouterController } from './RouterController.js';\nimport { TransactionsController } from './TransactionsController.js';\n// -- State --------------------------------------------- //\nconst state = proxy({\n  wcError: false,\n  buffering: false,\n  status: 'disconnected'\n});\n// eslint-disable-next-line init-declarations\nlet wcConnectionPromise;\n// -- Controller ---------------------------------------- //\nexport const ConnectionController = {\n  state,\n  subscribeKey(key, callback) {\n    return subKey(state, key, callback);\n  },\n  _getClient() {\n    return state._client;\n  },\n  setClient(client) {\n    state._client = ref(client);\n  },\n  async connectWalletConnect() {\n    if (CoreHelperUtil.isTelegram() || CoreHelperUtil.isSafari() && CoreHelperUtil.isIos()) {\n      if (wcConnectionPromise) {\n        await wcConnectionPromise;\n        wcConnectionPromise = undefined;\n        return;\n      }\n      if (!CoreHelperUtil.isPairingExpired(state?.wcPairingExpiry)) {\n        const link = state.wcUri;\n        state.wcUri = link;\n        return;\n      }\n      wcConnectionPromise = this._getClient()?.connectWalletConnect?.().catch(() => undefined);\n      this.state.status = 'connecting';\n      await wcConnectionPromise;\n      wcConnectionPromise = undefined;\n      state.wcPairingExpiry = undefined;\n      this.state.status = 'connected';\n    } else {\n      await this._getClient()?.connectWalletConnect?.();\n    }\n  },\n  async connectExternal(options, chain, setChain = true) {\n    await this._getClient()?.connectExternal?.(options);\n    if (setChain) {\n      ChainController.setActiveNamespace(chain);\n    }\n  },\n  async reconnectExternal(options) {\n    await this._getClient()?.reconnectExternal?.(options);\n    const namespace = options.chain || ChainController.state.activeChain;\n    if (namespace) {\n      ConnectorController.setConnectorId(options.id, namespace);\n    }\n  },\n  async setPreferredAccountType(accountType) {\n    ModalController.setLoading(true, ChainController.state.activeChain);\n    const authConnector = ConnectorController.getAuthConnector();\n    if (!authConnector) {\n      return;\n    }\n    await authConnector?.provider.setPreferredAccount(accountType);\n    await this.reconnectExternal(authConnector);\n    ModalController.setLoading(false, ChainController.state.activeChain);\n    EventsController.sendEvent({\n      type: 'track',\n      event: 'SET_PREFERRED_ACCOUNT_TYPE',\n      properties: {\n        accountType,\n        network: ChainController.state.activeCaipNetwork?.caipNetworkId || ''\n      }\n    });\n  },\n  async signMessage(message) {\n    return this._getClient()?.signMessage(message);\n  },\n  parseUnits(value, decimals) {\n    return this._getClient()?.parseUnits(value, decimals);\n  },\n  formatUnits(value, decimals) {\n    return this._getClient()?.formatUnits(value, decimals);\n  },\n  async sendTransaction(args) {\n    return this._getClient()?.sendTransaction(args);\n  },\n  async getCapabilities(params) {\n    return this._getClient()?.getCapabilities(params);\n  },\n  async grantPermissions(params) {\n    return this._getClient()?.grantPermissions(params);\n  },\n  async walletGetAssets(params) {\n    return this._getClient()?.walletGetAssets(params) ?? {};\n  },\n  async estimateGas(args) {\n    return this._getClient()?.estimateGas(args);\n  },\n  async writeContract(args) {\n    return this._getClient()?.writeContract(args);\n  },\n  async getEnsAddress(value) {\n    return this._getClient()?.getEnsAddress(value);\n  },\n  async getEnsAvatar(value) {\n    return this._getClient()?.getEnsAvatar(value);\n  },\n  checkInstalled(ids) {\n    return this._getClient()?.checkInstalled?.(ids) || false;\n  },\n  resetWcConnection() {\n    state.wcUri = undefined;\n    state.wcPairingExpiry = undefined;\n    state.wcLinking = undefined;\n    state.recentWallet = undefined;\n    state.status = 'disconnected';\n    TransactionsController.resetTransactions();\n    StorageUtil.deleteWalletConnectDeepLink();\n  },\n  resetUri() {\n    state.wcUri = undefined;\n    state.wcPairingExpiry = undefined;\n  },\n  finalizeWcConnection() {\n    const {\n      wcLinking,\n      recentWallet\n    } = ConnectionController.state;\n    if (wcLinking) {\n      StorageUtil.setWalletConnectDeepLink(wcLinking);\n    }\n    if (recentWallet) {\n      StorageUtil.setAppKitRecent(recentWallet);\n    }\n    EventsController.sendEvent({\n      type: 'track',\n      event: 'CONNECT_SUCCESS',\n      properties: {\n        method: wcLinking ? 'mobile' : 'qrcode',\n        name: RouterController.state.data?.wallet?.name || 'Unknown'\n      }\n    });\n  },\n  setWcBasic(wcBasic) {\n    state.wcBasic = wcBasic;\n  },\n  setUri(uri) {\n    state.wcUri = uri;\n    state.wcPairingExpiry = CoreHelperUtil.getPairingExpiry();\n  },\n  setWcLinking(wcLinking) {\n    state.wcLinking = wcLinking;\n  },\n  setWcError(wcError) {\n    state.wcError = wcError;\n    state.buffering = false;\n  },\n  setRecentWallet(wallet) {\n    state.recentWallet = wallet;\n  },\n  setBuffering(buffering) {\n    state.buffering = buffering;\n  },\n  setStatus(status) {\n    state.status = status;\n  },\n  async disconnect(namespace) {\n    try {\n      ModalController.setLoading(true, namespace);\n      await SIWXUtil.clearSessions();\n      await ChainController.disconnect(namespace);\n      ModalController.setLoading(false, namespace);\n      ConnectorController.setFilterByNamespace(undefined);\n    } catch (error) {\n      throw new Error('Failed to disconnect');\n    }\n  }\n};","map":{"version":3,"names":["proxy","ref","subscribeKey","subKey","CoreHelperUtil","SIWXUtil","StorageUtil","ChainController","ConnectorController","EventsController","ModalController","RouterController","TransactionsController","state","wcError","buffering","status","wcConnectionPromise","ConnectionController","key","callback","_getClient","_client","setClient","client","connectWalletConnect","isTelegram","isSafari","isIos","undefined","isPairingExpired","wcPairingExpiry","link","wcUri","catch","connectExternal","options","chain","setChain","setActiveNamespace","reconnectExternal","namespace","activeChain","setConnectorId","id","setPreferredAccountType","accountType","setLoading","authConnector","getAuthConnector","provider","setPreferredAccount","sendEvent","type","event","properties","network","activeCaipNetwork","caipNetworkId","signMessage","message","parseUnits","value","decimals","formatUnits","sendTransaction","args","getCapabilities","params","grantPermissions","walletGetAssets","estimateGas","writeContract","getEnsAddress","getEnsAvatar","checkInstalled","ids","resetWcConnection","wcLinking","recentWallet","resetTransactions","deleteWalletConnectDeepLink","resetUri","finalizeWcConnection","setWalletConnectDeepLink","setAppKitRecent","method","name","data","wallet","setWcBasic","wcBasic","setUri","uri","getPairingExpiry","setWcLinking","setWcError","setRecentWallet","setBuffering","setStatus","disconnect","clearSessions","setFilterByNamespace","error","Error"],"sources":["../../../../src/controllers/ConnectionController.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}