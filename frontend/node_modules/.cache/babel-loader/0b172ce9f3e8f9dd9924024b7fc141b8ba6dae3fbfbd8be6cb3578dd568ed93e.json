{"ast":null,"code":"import { Connection } from \"./core/connection.js\";\nimport { DEFAULT_POPUP_HEIGHT_PX, DEFAULT_POPUP_WIDTH_PX } from \"./core/constants.js\";\nimport { PopupEvent } from \"./core/types.js\";\nimport { openPopup, validateOrigin } from \"./core/utils.js\";\nexport class ConnectionManager {\n  constructor(platform) {\n    this.platform = platform;\n    this.connection = null;\n    this.popupWindow = null;\n    this.handleMessage = e => {\n      var _a, _b;\n      if (!validateOrigin(e.origin)) {\n        return;\n      }\n      const validatedOrigin = e.origin;\n      if (!this.popupWindow) {\n        return;\n      }\n      if (e.data.event === PopupEvent.HANDSHAKE && !this.connection) {\n        if (!this.verifyAndResetNonce((_a = e.data.payload) === null || _a === void 0 ? void 0 : _a.nonce)) {\n          return;\n        }\n        this.popupWindow.postMessage({\n          event: PopupEvent.HANDSHAKE_ACK,\n          payload: {\n            platform: this.platform\n          }\n        }, validatedOrigin);\n        this.connection = new Connection(validatedOrigin, this.popupWindow);\n        (_b = this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(this, this.connection);\n      }\n      if (!this.connection) {\n        return;\n      }\n      this.connection.runHandlersForEvent(e.data.event, e.data.payload);\n      if (e.data.event === PopupEvent.POPUP_CLOSED && this.connection) {\n        this.resetConnection();\n        this.popupWindow = null;\n      }\n    };\n  }\n  initialize() {\n    window.addEventListener('message', this.handleMessage);\n    return this;\n  }\n  tearDown() {\n    window.removeEventListener('message', this.handleMessage);\n    this.resetConnection();\n    return this;\n  }\n  async open({\n    url,\n    widthPx = DEFAULT_POPUP_WIDTH_PX,\n    heightPx = DEFAULT_POPUP_HEIGHT_PX,\n    nonce\n  }) {\n    var _a;\n    if ((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.closed) {\n      this.resetConnectionAndPopupWindow();\n    }\n    if (this.popupWindow) {\n      return;\n    }\n    this.initialize();\n    if (nonce) {\n      this.nonce = nonce;\n    }\n    const left = window.screenX + (window.innerWidth - widthPx) / 2;\n    const top = window.screenY + (window.innerHeight - heightPx) / 2;\n    this.popupWindow = openPopup({\n      height: heightPx,\n      left,\n      top,\n      url: typeof url === 'string' ? url : undefined,\n      width: widthPx\n    });\n    if (url instanceof Promise) {\n      this.setUrl(await url);\n    }\n  }\n  close() {\n    if (!this.popupWindow) {\n      return;\n    }\n    this.popupWindow.close();\n    this.resetConnectionAndPopupWindow();\n  }\n  onConnectionUpdated(callback) {\n    this.connectionUpdatedCallback = callback;\n    return this;\n  }\n  getConnection() {\n    return this.connection;\n  }\n  setUrl(url) {\n    if (!this.popupWindow) {\n      return;\n    }\n    this.popupWindow.location = url;\n  }\n  resetConnectionAndPopupWindow() {\n    this.resetConnection();\n    this.popupWindow = null;\n  }\n  resetConnection() {\n    var _a, _b;\n    (_a = this.connection) === null || _a === void 0 ? void 0 : _a.resetHandlers();\n    this.connection = null;\n    (_b = this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(this, this.connection);\n  }\n  verifyAndResetNonce(uncheckedNonce) {\n    if (!this.nonce) {\n      return true;\n    }\n    const result = uncheckedNonce === this.nonce;\n    if (result) {\n      this.nonce = undefined;\n    }\n    return result;\n  }\n}\n//# sourceMappingURL=connection-manager.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}